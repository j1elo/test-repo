# Workflow syntax for GitHub Actions:
# https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions

# Run some verification and organizative work on each newly opened issue.
name: New-Issue

# Run only when a new issue is opened.
# (roots/issue-closer action doesn't support other event types)
on:
  issues:
    types: [opened]

jobs:
  # Verify that the issue is valid in form.
  check-template:
    name: Check Template
    runs-on: ubuntu-latest

    steps:
      # Close the issue if its body doesn't match a regular expression.
      # https://github.com/marketplace/actions/issue-auto-closer
      - name: Issue auto-closer
        uses: roots/issue-closer-action@v1.1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          issue-pattern: '\[[xX]\] I agree to fill this issue template'
          issue-close-message: >
            Hello @${{ github.event.issue.user.login }} :wave:! we're sorry you
            found a bug... thank you very much for reporting it.


            However, **your report doesn't follow the [issue template](https://github.com/j1elo/test-repo/blob/master/.github/ISSUE_TEMPLATE/bug_report.md)**,
            so it is being automatically closed. We are really sorry for that,
            but we need all reports to follow the template, or else it won't be
            possible to understand and help with all issues.


            Please, create a new issue following the template, or reopen this
            same issue to edit and provide all required information.

  # Run the issue through some initial process.
  process-issue:
    name: Process Issue
    runs-on: ubuntu-latest

    # Wait for previous job to finish (disable parallel run).
    needs: check-template

    steps:
      # Get the current Issue data, to see if "check-template" closed it.
      # https://github.com/marketplace/actions/github-api-request
      - id: get-issue
        name: Get Issue Data
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/:owner/:repo/issues/:issue_number
          owner: ${{ github.event.repository.owner.login }}
          repo: ${{ github.event.repository.name }}
          issue_number: ${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Add the issue to the incoming Triage project.
      # https://github.com/marketplace/actions/github-project-automation
      - name: GitHub Project Automation+
        uses: alex-page/github-project-automation-plus@v0.3.0
        # Run only if "check-template" didn't close the issue.
        if: ${{ fromJson(steps.get-issue.outputs.data).state == 'open' }}
        with:
          repo-token: ${{ secrets.NEW_ISSUE_TOKEN }}
          project: projectABCDE
          column: Backlog Candidates

      # Add a thank you message.
      # https://github.com/marketplace/actions/create-or-update-comment
      - name: Create or Update Comment
        uses: peter-evans/create-or-update-comment@v1.4.3
        # Run only if "check-template" didn't close the issue.
        if: ${{ fromJson(steps.get-issue.outputs.data).state == 'open' }}
        with:
          issue-number: ${{ github.event.issue.number }}
          body: >
            Hello @${{ github.event.issue.user.login }} :wave:! we're sorry you
            found a bug... thank you very much for reporting it.


            To know about progress, check in
            **[Triage](https://github.com/users/j1elo/projects/1)**. All issues
            are considered
            [Backlog Candidates](https://github.com/users/j1elo/projects/1#column-10993293)
            until work priorities align and the issue is selected for
            development. It will then become part of our official
            [Backlog](https://github.com/users/j1elo/projects/1#column-10993299).


            Kurento is made by a small team of people. This means that our work
            pipeline is quite restricted, and most tasks end up being stored in
            the backlog for a long time. We advance as fast as we can, but time
            and resources are limited and at the end of the day there is so much
            that we can do.


            If solving this issue is especially urgent for you, or you want to
            help with funding development of Kurento, we offer on-demand support
            services. Please get in touch at openvidu@gmail.com and let us know!
